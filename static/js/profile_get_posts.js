// Generated by CoffeeScript 1.4.0
(function() {

  $(document).ready(function() {
    var $postReplyBox, $postReplyBoxAppendedToButton, $postReplyBoxCharactersRemaining, $postReplyBoxContent, $postReplyBoxFooter, $postReplyBoxPost, $postReplyBoxPostContainer, $postReplyBoxTextBox, $postTopLayer, $window, GET_POSTS_LENGTH, MAXIMUM_POST_LENGTH, NO_POSTS_TIME, SHOW_TIME, UPDATE_TIME_SECONDS, WINDOW_BOTTOM_LOAD_NEW_POSTS_SCROLL, buildPostHtml, closePostReplyBox, detectScroll, getTopPostsApi, gotAllPosts, gotAmount, hideChildren, isTopLayerVisiblePost, loadNextPosts, loadingNext, onDeleteClicked, onPostReplyClicked, onPostReplyOpenClicked, onViewConversationClicked, onViewRepliesClicked, postReplyBoxAppendedToId, postReplyClicked, renderFirstPosts, topLayerVisiblePosts, viewRepliesPressed;
    $("html, body").animate({
      scrollTop: "0px"
    });
    GET_POSTS_LENGTH = 10;
    gotAmount = 0;
    UPDATE_TIME_SECONDS = 20;
    WINDOW_BOTTOM_LOAD_NEW_POSTS_SCROLL = 128;
    topLayerVisiblePosts = [];
    isTopLayerVisiblePost = function(id) {
      var i, _i, _len;
      for (_i = 0, _len = topLayerVisiblePosts.length; _i < _len; _i++) {
        i = topLayerVisiblePosts[_i];
        if (id === i) {
          return true;
        }
      }
      return false;
    };
    $postTopLayer = $("#post-top-layer");
    SHOW_TIME = 400;
    NO_POSTS_TIME = 450;
    viewRepliesPressed = false;
    MAXIMUM_POST_LENGTH = 256;
    $postReplyBox = $("<div>");
    $postReplyBox.attr("id", "post-reply-box");
    $postReplyBoxAppendedToButton = null;
    postReplyBoxAppendedToId = -1;
    $postReplyBoxContent = $("<div>");
    $postReplyBoxContent.attr("id", "post-reply-box-content");
    $postReplyBoxTextBox = $("<textarea>");
    $postReplyBoxTextBox.attr("id", "post-reply-box-text-box");
    $postReplyBoxTextBox.attr("type", "text");
    $postReplyBoxTextBox.attr("placeholder", "Type a reply");
    $postReplyBoxTextBox.attr("autofocus", "autofocus");
    $postReplyBoxTextBox.attr("maxlength", MAXIMUM_POST_LENGTH);
    $postReplyBoxTextBox.attr("name", "reply");
    $postReplyBoxTextBox.attr("spellcheck", "true");
    $postReplyBoxTextBox.attr("autocorrect", "on");
    $postReplyBoxTextBox.attr("autocapitalize", "on");
    $postReplyBoxContent.append($postReplyBoxTextBox);
    $postReplyBox.append($postReplyBoxContent);
    $postReplyBoxFooter = $("<div>");
    $postReplyBoxFooter.attr("id", "post-reply-box-footer");
    $postReplyBoxCharactersRemaining = $("<span>");
    $postReplyBoxCharactersRemaining.addClass("post-small-text-left");
    $postReplyBoxCharactersRemaining.text("" + MAXIMUM_POST_LENGTH + " characters remaining");
    $postReplyBoxFooter.append($postReplyBoxCharactersRemaining);
    $postReplyBoxPostContainer = $("<div>");
    $postReplyBoxPostContainer.attr("id", "post-reply-box-post-container");
    $postReplyBoxPost = $("<div>");
    $postReplyBoxPost.attr("id", "post-reply-box-post");
    $postReplyBoxPost.text("Post");
    $postReplyBoxPostContainer.append($postReplyBoxPost);
    $postReplyBoxFooter.append($postReplyBoxPostContainer);
    $postReplyBox.append($postReplyBoxFooter);
    $postReplyBoxTextBox.bind("input propertychange", function() {
      var charactersRemaining, red, start;
      charactersRemaining = MAXIMUM_POST_LENGTH - this.value.length;
      $postReplyBoxCharactersRemaining.text("" + charactersRemaining + " character" + (charactersRemaining !== 1 ? 's' : '') + " remaining");
      start = 50;
      if (charactersRemaining < start) {
        red = Math.floor(255 * (start - charactersRemaining) / start);
        return $postReplyBoxCharactersRemaining.css("color", "rgb(" + red + ", 0, 0)");
      } else {
        return $postReplyBoxCharactersRemaining.css("color", "black");
      }
    });
    closePostReplyBox = function($button) {
      if ($postReplyBoxAppendedToButton == null) {
        return;
      }
      $postReplyBox.slideUp(SHOW_TIME, function() {
        return $postReplyBox.detach();
      });
      if (postReplyBoxAppendedToId === "NEW") {
        $button.text("Post a new post");
      } else {
        $button.text("Post reply");
      }
      $postReplyBoxAppendedToButton = null;
      return postReplyBoxAppendedToId = -1;
    };
    onPostReplyOpenClicked = function() {
      var $button, id;
      $button = $(this);
      id = $button.parent().parent().data("post-id");
      if ($postReplyBoxAppendedToButton != null ? $postReplyBoxAppendedToButton.is($button) : void 0) {
        return closePostReplyBox($button);
      } else {
        if ($postReplyBoxAppendedToButton != null) {
          if (postReplyBoxAppendedToId === "NEW") {
            $postReplyBoxAppendedToButton.text("Post a new post");
          } else {
            $postReplyBoxAppendedToButton.text("Post reply");
          }
        }
        $button.text("Close");
        $postReplyBoxAppendedToButton = $button;
        postReplyBoxAppendedToId = id;
        return $postReplyBox.slideUp(SHOW_TIME, function() {
          return $postReplyBox.appendTo($button.parent().parent()).hide().slideDown(SHOW_TIME, function() {
            return $postReplyBoxTextBox.focus();
          });
        });
      }
    };
    postReplyClicked = false;
    onPostReplyClicked = function() {
      var $blankPost, $button, id, postContent;
      if (postReplyClicked) {
        return;
      }
      postReplyClicked = true;
      $button = $(this);
      postContent = $postReplyBoxTextBox.val();
      if (postContent.length === 0) {
        $blankPost = $("<span>");
        $blankPost.addClass("post-small-text-right");
        $blankPost.text("Please enter a post");
        $blankPost.hide();
        $button.after($blankPost);
        $blankPost.show(SHOW_TIME).delay(NO_POSTS_TIME).hide(SHOW_TIME, function() {
          $blankPost.remove();
          return postReplyClicked = false;
        });
        return;
      }
      id = postReplyBoxAppendedToId;
      return $.ajax({
        type: "POST",
        url: "/api/post-post/",
        data: {
          content: postContent,
          replyToId: id
        }
      }).done(function(data) {
        var $parent;
        $postReplyBoxTextBox.val("");
        $postReplyBoxTextBox.text("");
        closePostReplyBox($postReplyBoxAppendedToButton);
        if (id === "NEW" || viewingSelf) {
          buildPostHtml(data.post, $postTopLayer, {
            isTopLayer: true,
            prepend: true
          });
        }
        if (id !== "NEW") {
          $parent = $button.parent().parent().parent().parent().parent().children(".post-replies");
          buildPostHtml(data.post, $parent, {
            prepend: true
          });
          $button.parent().parent().parent().parent().children(".post-footer").children(".post-view-reply").text("Close");
        }
        return postReplyClicked = false;
      });
    };
    $postReplyBoxPost.click(onPostReplyClicked);
    hideChildren = function($container, func) {
      var $postReplies;
      $postReplies = $container.children(".post-replies");
      return $postReplies.slideUp(SHOW_TIME, function() {
        $postReplies.children().remove();
        $postReplies.slideDown();
        return func();
      });
    };
    onViewRepliesClicked = function() {
      var $button, $postReplyContainer, id;
      viewRepliesPressed = true;
      $button = $(this);
      $postReplyContainer = $button.parent().parent().parent().children(".post-replies");
      if ($postReplyContainer.children().length === 0) {
        id = $button.parent().parent().data("post-id");
        return $.getJSON("/api/get-replies-to/" + id + "/", function(data) {
          var $noPosts, post, _i, _len, _ref;
          if (data.posts.length === 0) {
            $noPosts = $("<span>");
            $noPosts.addClass("post-small-text-left");
            $noPosts.text("No posts to display");
            $noPosts.hide();
            $button.after($noPosts);
            return $noPosts.show(SHOW_TIME).delay(NO_POSTS_TIME).hide(SHOW_TIME, function() {
              $noPosts.remove();
              return viewRepliesPressed = false;
            });
          } else {
            _ref = data.posts;
            for (_i = 0, _len = _ref.length; _i < _len; _i++) {
              post = _ref[_i];
              buildPostHtml(post, $postReplyContainer);
            }
            $button.text("Close");
            return viewRepliesPressed = false;
          }
        });
      } else {
        return hideChildren($postReplyContainer.parent(), function() {
          $button.text("View replies");
          return viewRepliesPressed = false;
        });
      }
    };
    onViewConversationClicked = function() {
      var $button, showNextConversationLayer;
      $button = $(this);
      showNextConversationLayer = function() {
        var $container, $post, $replies, id;
        $post = $button.parent().parent();
        id = $post.data("post-is-reply-to-id");
        if (!(id != null) || id === "") {
          return;
        }
        $container = $post.parent();
        $replies = $container.children(".post-replies");
        return $.getJSON("/api/get-post/" + id + "/", function(data) {
          var $postContainer;
          $post.detach();
          $replies.detach();
          buildPostHtml(data.post, $container, {
            attachToParent: true,
            animate: false,
            showViewConversation: true
          });
          $container.children(".post").hide().slideDown(SHOW_TIME);
          $container.children(".post").children(".post-footer").children(".post-view-reply").text("Close");
          $postContainer = $("<div>");
          $postContainer.addClass("post-container");
          $postContainer.append($post);
          $postContainer.append($replies);
          $postContainer.appendTo($container.children(".post-replies"));
          if (data.post.isReplyTo) {
            $button.remove();
          } else {
            $button.hide(SHOW_TIME).remove();
          }
          if (data.post.isReplyTo) {
            $button = $container.children(".post").children(".post-header").children(".post-view-conversation");
            return setTimeout(showNextConversationLayer, SHOW_TIME + 100);
          }
        });
      };
      return showNextConversationLayer();
    };
    onDeleteClicked = function() {
      var $button, $post, id;
      $button = $(this);
      $post = $button.parent().parent();
      id = $post.data("post-id");
      return new ConfirmDialogue({
        title: "Deleting Post",
        body: ["Are you sure you want to delete this post?", $post.children(".post-content").text()],
        yesFunction: function(dialogue) {
          dialogue.close();
          return $.ajax({
            type: "POST",
            url: "/api/delete-post/",
            data: {
              id: id
            }
          }).done(function() {
            var i, _i, _ref, _results;
            $postTopLayer.find(".post").each(function() {
              var $container, foundId;
              foundId = $(this).data("post-id");
              if (foundId === id) {
                $container = $(this).parent();
                return $container.slideUp(SHOW_TIME, function() {
                  var $replies;
                  $replies = $container.parent();
                  $container.remove();
                  if ($replies.hasClass("post-replies") && $replies.children().length === 0) {
                    return $replies.parent().children(".post").children(".post-footer").children(".post-view-reply").text("View replies");
                  }
                });
              }
            });
            _results = [];
            for (i = _i = 0, _ref = topLayerVisiblePosts.length; 0 <= _ref ? _i < _ref : _i > _ref; i = 0 <= _ref ? ++_i : --_i) {
              if (topLayerVisiblePosts[i] === id) {
                _results.push(topLayerVisiblePosts.splice(i, 1));
              } else {
                _results.push(void 0);
              }
            }
            return _results;
          });
        }
      });
    };
    buildPostHtml = function(post, $parent, options) {
      var $firstPostUserLink, $post, $postContainer, $postContent, $postDate, $postDelete, $postFooter, $postHeader, $postPostReply, $postReplies, $postViewReplies, $posterLink, $viewConversation, animate, attachToParent, firstPost, isTopLayer, prepend, showViewConversation;
      if (options == null) {
        options = {};
      }
      isTopLayer = options.isTopLayer || false;
      attachToParent = options.attachToParent || false;
      animate = options.animate || true;
      prepend = options.prepend || false;
      showViewConversation = options.showViewConversation || false;
      if (isTopLayer && isTopLayerVisiblePost(post.id)) {
        return;
      }
      $postContainer = null;
      if (attachToParent) {
        $postContainer = $parent;
      } else {
        $postContainer = $("<div>");
        $postContainer.addClass("post-container");
      }
      $post = $("<div>");
      $post.addClass("post");
      $postHeader = $("<header>");
      $postHeader.addClass("post-header");
      $posterLink = $("<a>");
      $posterLink.addClass("post-poster-link");
      $posterLink.attr("href", post.poster.absoluteUrl);
      $posterLink.text("" + post.poster.fullName + " - " + post.poster.username);
      $postHeader.append($posterLink);
      if (post.isReplyTo && showViewConversation) {
        firstPost = post.isReplyTo;
        $viewConversation = $("<div>");
        $viewConversation.addClass("post-view-conversation");
        $viewConversation.text("View conversation");
        $viewConversation.click(onViewConversationClicked);
        $post.data("post-is-reply-to-id", firstPost.id);
        $postHeader.append($viewConversation);
      }
      $postDate = $("<div>");
      $postDate.addClass("post-date");
      $postDate.text("" + post.date);
      $postHeader.append($postDate);
      $post.append($postHeader);
      $postContent = $("<section>");
      $postContent.addClass("post-content");
      if (post.isReplyTo) {
        firstPost = post.isReplyTo;
        $firstPostUserLink = $("<a>");
        $firstPostUserLink.addClass("post-reply-to-username");
        $firstPostUserLink.attr("href", firstPost.poster.absoluteUrl);
        $firstPostUserLink.text("@" + firstPost.poster.fullName);
        $postContent.append($firstPostUserLink);
        $postContent.append(": ");
      }
      $postContent.append("" + post.content);
      $post.append($postContent);
      $postFooter = $("<footer>");
      $postFooter.addClass("post-footer");
      $postViewReplies = $("<div>");
      $postViewReplies.addClass("post-view-reply");
      $postViewReplies.text("View replies");
      $postFooter.append($postViewReplies);
      $postPostReply = $("<div>");
      $postPostReply.addClass("post-post-reply");
      $postPostReply.text("Post reply");
      $postFooter.append($postPostReply);
      $postPostReply.click(onPostReplyOpenClicked);
      if (post.isDeletableByLoggedInUser) {
        $postDelete = $("<div>");
        $postDelete.addClass("post-delete");
        $postDelete.text("Delete");
        $postFooter.append($postDelete);
        $postDelete.click(onDeleteClicked);
      }
      $post.append($postFooter);
      $post.data("post-id", post.id);
      if (isTopLayer) {
        topLayerVisiblePosts.push(post.id);
      }
      $postContainer.prepend($post);
      if (!$postContainer.has(".post-replies").length) {
        $postReplies = $("<div>");
        $postReplies.addClass("post-replies");
        $postContainer.append($postReplies);
      }
      if (prepend) {
        $parent.prepend($postContainer);
      } else {
        $parent.append($postContainer);
      }
      if (animate) {
        $postContainer.hide(0, function() {
          return $postContainer.slideDown(SHOW_TIME);
        });
      }
      return $postViewReplies.click(onViewRepliesClicked);
    };
    getTopPostsApi = "";
    renderFirstPosts = function(data, prepend) {
      var post, _i, _len, _ref;
      if (prepend == null) {
        prepend = false;
      }
      _ref = data.posts;
      for (_i = 0, _len = _ref.length; _i < _len; _i++) {
        post = _ref[_i];
        if (!isTopLayerVisiblePost(post.id)) {
          gotAmount += 1;
          buildPostHtml(post, $postTopLayer, {
            isTopLayer: true,
            prepend: prepend,
            showViewConversation: true
          });
        }
      }
      return null;
    };
    getTopPostsApi = viewingSelf ? "/api/get-posts-by-users-followed-by/" + loggedInUsername + "/" : "/api/get-posts-by/" + viewingUsername + "/";
    getTopPostsApi += "" + GET_POSTS_LENGTH + "/";
    $.getJSON(getTopPostsApi, function(data) {
      return renderFirstPosts(data);
    });
    $("#post-new-post-button").click(onPostReplyOpenClicked);
    loadingNext = false;
    gotAllPosts = false;
    loadNextPosts = function() {
      var getApi;
      if (loadingNext || gotAllPosts) {
        return;
      }
      loadingNext = true;
      getApi = getTopPostsApi + (gotAmount === 0 ? "0" : gotAmount.toString()) + "/";
      return $.getJSON(getApi, function(data) {
        renderFirstPosts(data);
        if (data.posts.length === 0) {
          gotAllPosts = true;
        }
        return loadingNext = false;
      });
    };
    $window = $(window);
    detectScroll = function() {
      if ($window.scrollTop() + $window.height() >= $(document).height() - WINDOW_BOTTOM_LOAD_NEW_POSTS_SCROLL) {
        return loadNextPosts();
      }
    };
    $window.scroll(detectScroll);
    return setInterval(function() {
      return $.getJSON(getTopPostsApi, function(data) {
        return renderFirstPosts(data, true);
      });
    }, UPDATE_TIME_SECONDS * 1000);
  });

}).call(this);
